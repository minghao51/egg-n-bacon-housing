---
/**
 * Tooltip component for explaining technical terms in analytics docs
 *
 * @param term - The technical term to look up in glossary (required)
 * @param definition - Custom definition override (optional)
 * @param whyItMatters - Custom "why it matters" override (optional)
 */
import glossary from '@/data/analytics-glossary.json';

interface Props {
  term: string;
  definition?: string;
  whyItMatters?: string;
  class?: string;
}

const { term, definition, whyItMatters, class: className } = Astro.props;

// Look up term in glossary, or use custom values if provided
const entry = glossary[term];
const expl = definition || entry?.explanation;
const matter = whyItMatters || entry?.whyItMatters;

if (!expl) {
  console.warn(`Tooltip: term "${term}" not found in glossary and no custom definition provided`);
}
---

<span
  class="tooltip-trigger relative inline-block border-b border-dotted border-muted-foreground/50 cursor-help {className}"
  data-term={term}
>
  <slot>{term}</slot>

  <div class="tooltip-content invisible absolute z-50 w-80 rounded-lg bg-popover p-4 shadow-lg opacity-0 transition-opacity group-hover:visible group-hover:opacity-100"
       role="tooltip"
  >
    <div class="mb-2 text-sm font-semibold text-foreground">
      {term}
    </div>
    <div class="mb-2 text-sm text-card-foreground">
      {expl}
    </div>
    {matter && (
      <div class="mt-3 border-t border-border pt-2 text-xs text-muted-foreground">
        <span class="font-medium">ðŸ’¡ Why it matters:</span> {matter}
      </div>
    )}
  </div>
</span>

<style>
  /* Desktop: hover to show tooltip */
  @media (hover: hover) {
    .tooltip-trigger:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }
  }

  /* Mobile: tap to show tooltip (requires JS) */
  @media (hover: none) {
    .tooltip-content {
      visibility: hidden;
      opacity: 0;
    }

    .tooltip-trigger.tapped .tooltip-content {
      visibility: visible;
      opacity: 1;
    }
  }

  /* Tooltip positioning - default above */
  .tooltip-content {
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
  }

  /* Prevent overflow on right edge */
  .tooltip-content.right {
    left: auto;
    right: 0;
    transform: none;
  }

  /* Prevent overflow on left edge */
  .tooltip-content.left {
    left: 0;
    right: auto;
    transform: none;
  }

  /* Show below if no space above */
  .tooltip-content.below {
    bottom: auto;
    top: calc(100% + 8px);
  }
</style>

<script>
  // Mobile tap-to-show functionality
  const trigger = document.querySelector('.tooltip-trigger');
  if (trigger) {
    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      trigger.classList.toggle('tapped');

      // Close other open tooltips
      document.querySelectorAll('.tooltip-trigger.tapped').forEach(el => {
        if (el !== trigger) el.classList.remove('tapped');
      });

      // Close when clicking outside
      const closeOnOutsideClick = (e: Event) => {
        if (!trigger.contains(e.target as Node)) {
          trigger.classList.remove('tapped');
          document.removeEventListener('click', closeOnOutsideClick);
        }
      };
      setTimeout(() => {
        document.addEventListener('click', closeOnOutsideClick);
      }, 0);
    });
  }
</script>
