---
/**
 * Interactive decision checklist for evaluating properties
 *
 * @param title - Checklist title (required)
 * @param storageKey - Unique key for localStorage persistence (optional)
 */
interface Props {
  title: string;
  storageKey?: string;
}

const { title, storageKey } = Astro.props;

// Generate a unique ID for this checklist if no storage key provided
const checklistId = storageKey || `checklist-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="checklist-box rounded-lg border border-border bg-card p-6 my-6" data-checklist-id={checklistId}>
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-2xl">âœ…</span>
      <h3 class="text-lg font-semibold text-foreground">
        {title}
      </h3>
    </div>
    <button
      class="text-sm text-muted-foreground hover:text-foreground transition-colors"
      onclick={"resetChecklist('" + checklistId + "')"}
      aria-label="Reset checklist"
    >
      Reset
    </button>
  </div>

  <!-- Content -->
  <div class="prose prose-sm max-w-none dark:prose-invert">
    <slot />
  </div>
</div>

<!-- Checklist functionality script -->
<script define:vars={{ checklistId }}>
  // Load saved state from localStorage
  const loadState = () => {
    try {
      const saved = localStorage.getItem(`checklist-${checklistId}`);
      return saved ? JSON.parse(saved) : {};
    } catch {
      return {};
    }
  };

  // Save state to localStorage
  const saveState = (state) => {
    try {
      localStorage.setItem(`checklist-${checklistId}`, JSON.stringify(state));
    } catch (e) {
      console.warn('Failed to save checklist state:', e);
    }
  };

  // Initialize checklist on mount
  const checklist = document.querySelector(`[data-checklist-id="${checklistId}"]`);
  if (checklist) {
    const state = loadState();

    // Restore saved checkbox states
    Object.entries(state).forEach(([index, checked]) => {
      const checkbox = checklist.querySelector(`input[data-index="${index}"]`);
      if (checkbox) {
        checkbox.checked = checked;
      }
    });

    // Save checkbox changes
    checklist.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox') {
        const index = e.target.dataset.index;
        if (index) {
          state[index] = e.target.checked;
          saveState(state);
        }
      }
    });
  }

  // Global reset function
  (window as any).resetChecklist = (id: string) => {
    const targetChecklist = document.querySelector(`[data-checklist-id="${id}"]`);
    if (targetChecklist) {
      const checkboxes = targetChecklist.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach((cb: HTMLInputElement) => cb.checked = false);
      localStorage.removeItem(`checklist-${id}`);
    }
  };
</script>

<style>
  /* Style checklist items */
  .checklist-box :global(input[type="checkbox"]) {
    @apply h-4 w-4 rounded border-border text-primary focus:ring-primary;
  }

  .checklist-box :global(label) {
    @apply ml-3 text-card-foreground cursor-pointer hover:text-foreground transition-colors;
  }

  .checklist-box :global(li) {
    @apply flex items-start mb-2;
  }
</style>
