---
import Layout from '@/layouts/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import { getCollection } from 'astro:content';

const allDocs = await getCollection('analytics');

// Category configuration
const categoryConfig = {
  'investment-guides': {
    label: 'Investment Guides',
    icon: 'ðŸ’¼',
    description: 'Actionable insights for investors and buyers',
  },
  'market-analysis': {
    label: 'Market Analysis',
    icon: 'ðŸ“Š',
    description: 'Trends and patterns in housing market',
  },
  'technical-reports': {
    label: 'Technical Reports',
    icon: 'ðŸ”¬',
    description: 'Methodology and statistical models',
  },
  'quick-reference': {
    label: 'Quick Reference',
    icon: 'ðŸ“‹',
    description: 'Tables and condensed summaries',
  },
};

// Group documents by category
const docsByCategory = allDocs.reduce((acc, doc) => {
  const category = doc.data.category || 'technical-reports'; // Default fallback
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push({
    slug: doc.slug,
    title: doc.data.title || doc.slug,
    description: doc.data.description || '',
    category: doc.data.category,
  });
  return acc;
}, {} as Record<string, Array<{
  slug: string;
  title: string;
  description: string;
  category: string;
}>>);

// Sort categories by display order
const sortedCategories = Object.keys(categoryConfig).filter(
  cat => docsByCategory[cat]?.length > 0
);
---

<Layout title="Analytics - Singapore Housing Market">
  <Sidebar />

  <main class="flex-1 ml-64">
    <div class="max-w-4xl mx-auto px-8 py-12">
      <!-- Header -->
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-foreground mb-2">
          Singapore Housing Market Analytics
        </h1>
        <p class="text-lg text-muted-foreground">
          Comprehensive analysis of HDB and Condo market trends, rental yields,
          spatial patterns, and policy impacts.
        </p>
      </header>

      <!-- Quick Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
        <div class="bg-card border border-border rounded-lg p-6">
          <div class="text-sm font-medium text-muted-foreground mb-1">
            Total Reports
          </div>
          <div class="text-3xl font-bold text-foreground">{allDocs.length}</div>
        </div>
        <div class="bg-card border border-border rounded-lg p-6">
          <div class="text-sm font-medium text-muted-foreground mb-1">
            Data Coverage
          </div>
          <div class="text-3xl font-bold text-foreground">11 Years</div>
        </div>
        <div class="bg-card border border-border rounded-lg p-6">
          <div class="text-sm font-medium text-muted-foreground mb-1">
            Categories
          </div>
          <div class="text-3xl font-bold text-foreground">{sortedCategories.length}</div>
        </div>
      </div>

      <!-- Category Sections -->
      <div class="space-y-8">
        {sortedCategories.map((category) => (
          <section class="border border-border rounded-lg overflow-hidden">
            <details class="group" open>
              <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-accent transition-colors">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">{categoryConfig[category].icon}</span>
                  <div>
                    <h2 class="text-xl font-semibold text-foreground">
                      {categoryConfig[category].label}
                    </h2>
                    <p class="text-sm text-muted-foreground">
                      {categoryConfig[category].description}
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-muted-foreground">
                    {docsByCategory[category].length} {docsByCategory[category].length === 1 ? 'report' : 'reports'}
                  </span>
                  <svg
                    class="w-5 h-5 text-muted-foreground transition-transform group-open:rotate-90"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width={2}
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </div>
              </summary>

              <div class="p-6 pt-0 border-t border-border">
                <div class="grid grid-cols-1 gap-3 mt-6">
                  {docsByCategory[category].sort((a, b) => a.slug.localeCompare(b.slug)).map((doc) => (
                    <a
                      href={`${import.meta.env.BASE_URL}analytics/${doc.slug}`}
                      class="block p-4 bg-card border border-border rounded-lg hover:bg-accent transition-colors"
                    >
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <h3 class="font-semibold text-foreground">
                            {doc.title}
                          </h3>
                          <p class="text-sm text-muted-foreground mt-1">
                            {doc.description}
                          </p>
                        </div>
                        <svg
                          class="w-5 h-5 text-muted-foreground ml-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width={2}
                            d="M9 5l7 7-7 7"
                          />
                        </svg>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </details>
          </section>
        ))}
      </div>
    </div>
  </main>
</Layout>
