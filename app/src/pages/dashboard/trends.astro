---
import Layout from '@/layouts/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import TrendsDashboard from '@/components/dashboard/TrendsDashboard';
import fs from 'fs';
import path from 'path';
import zlib from 'zlib';

// Read data at build time
function gunzip(data) {
  return zlib.gunzipSync(data).toString('utf-8');
}

const dataPath = path.resolve('public/data/dashboard_trends.json.gz');
let trendsData;

try {
  const rawData = fs.readFileSync(dataPath);
  const decompressed = gunzip(rawData);
  trendsData = JSON.parse(decompressed);
} catch (error) {
  console.error("Failed to load trends data:", error);
}

// NEW: Load interactive tools data
const mrtCbdPath = path.resolve('public/data/interactive_tools/mrt_cbd_impact.json.gz');
let mrtCbdData;

try {
  const rawData = fs.readFileSync(mrtCbdPath);
  const decompressed = gunzip(rawData);
  mrtCbdData = JSON.parse(decompressed);
} catch (error) {
  console.error("Failed to load MRT/CBD impact data:", error);
}

const leaseDecayPath = path.resolve('public/data/interactive_tools/lease_decay_analysis.json.gz');
let leaseDecayData;

try {
  const rawData = fs.readFileSync(leaseDecayPath);
  const decompressed = gunzip(rawData);
  leaseDecayData = JSON.parse(decompressed);
} catch (error) {
  console.error("Failed to load lease decay data:", error);
}

const affordabilityPath = path.resolve('public/data/interactive_tools/affordability_metrics.json.gz');
let affordabilityData;

try {
  const rawData = fs.readFileSync(affordabilityPath);
  const decompressed = gunzip(rawData);
  affordabilityData = JSON.parse(decompressed);
} catch (error) {
  console.error("Failed to load affordability data:", error);
}

const hotspotsPath = path.resolve('public/data/interactive_tools/spatial_hotspots.json.gz');
let hotspotsData;

try {
  const rawData = fs.readFileSync(hotspotsPath);
  const decompressed = gunzip(rawData);
  hotspotsData = JSON.parse(decompressed);
} catch (error) {
  console.error("Failed to load hotspots data:", error);
}
---

<Layout title="Trends Explorer - Dashboard">
  <Sidebar />

  <main class="flex-1 ml-0 lg:ml-64 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-8 py-8">
      {/* Header */}
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-foreground">Trends Explorer</h1>
        <p class="text-muted-foreground mt-2">
          Historical price and volume trends across different property types.
        </p>
      </header>

      {/* Dashboard Content */}
      {trendsData ? (
        <TrendsDashboard
          client:load
          data={trendsData}
          mrtCbdData={mrtCbdData}
          leaseDecayData={leaseDecayData}
          affordabilityData={affordabilityData}
          hotspotsData={hotspotsData}
        />
      ) : (
        <div class="p-8 text-center text-muted-foreground bg-card border border-border rounded-lg">
          Data not available. Please run the export script.
        </div>
      )}
    </div>
  </main>
</Layout>
