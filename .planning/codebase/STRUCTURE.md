# Structure

## Directory Layout

```
egg-n-bacon-housing/
├── .env                     # Environment variables (API keys)
├── .env.example             # Template for .env
├── pyproject.toml           # Python project config (uv)
├── jupytext.toml            # Jupyter notebook pairing config
│
├── scripts/                 # Python ETL pipeline
│   ├── run_pipeline.py     # Main entry point (CLI orchestrator)
│   ├── prepare_webapp_data.py
│   ├── prepare_analytics_json.py
│   │
│   ├── core/                # Core modules
│   │   ├── config.py        # Centralized configuration
│   │   ├── data_helpers.py  # Parquet I/O with metadata
│   │   ├── geocoding.py     # OneMap/Google geocoding
│   │   ├── cache.py         # API response caching
│   │   ├── metrics.py       # Dashboard metrics
│   │   ├── mrt_distance.py  # MRT proximity calculations
│   │   ├── mrt_line_mapping.py  # Hardcoded MRT stations (534 lines)
│   │   ├── school_features.py    # School tier features
│   │   ├── regional_mapping.py    # Regional boundaries
│   │   │
│   │   ├── stages/          # Pipeline stages (L0-L5)
│   │   │   ├── L0_collect.py
│   │   │   ├── L1_process.py
│   │   │   ├── L2_features.py
│   │   │   ├── L2_rental.py
│   │   │   ├── L3_export.py     # Largest: 1632 lines
│   │   │   ├── L4_analysis.py
│   │   │   ├── L5_metrics.py
│   │   │   ├── webapp_data_preparation.py
│   │   │   ├── spatial_h3.py
│   │   │   └── helpers/         # Stage-specific helpers
│   │   │
│   │   └── logging_config.py
│   │
│   ├── analytics/           # ML models and analysis
│   │   ├── models/
│   │   ├── pipelines/
│   │   ├── segmentation/
│   │   ├── viz/
│   │   └── analysis/
│   │
│   ├── data/                # Data processing scripts
│   │   ├── download/
│   │   ├── process/
│   │   │   ├── geocode/
│   │   │   ├── amenities/
│   │   │   └── planning_area/
│   │   └── create_l3_unified_dataset.py
│   │
│   └── utils/               # Utility scripts
│
├── app/                     # Astro/React frontend
│   ├── index.ts             # Entry point (dummy)
│   ├── astro.config.mjs    # Astro configuration
│   ├── package.json
│   ├── tsconfig.json
│   ├── tailwind.config.mjs
│   │
│   ├── src/
│   │   ├── pages/           # Astro pages
│   │   │   ├── index.astro
│   │   │   ├── dashboard/
│   │   │   │   ├── index.astro
│   │   │   │   ├── map.astro
│   │   │   │   ├── trends.astro
│   │   │   │   ├── leaderboard.astro
│   │   │   │   └── segments.astro
│   │   │   └── analytics/
│   │   │       ├── index.astro
│   │   │       └── [slug].astro
│   │   │
│   │   ├── components/      # Astro + React components
│   │   ├── layouts/
│   │   ├── hooks/
│   │   ├── styles/
│   │   ├── types/
│   │   ├── utils/
│   │   └── data/            # Static data
│   │
│   └── public/
│       └── data/            # JSON data files (generated by Python)
│
├── data/                    # Data outputs
│   ├── metadata.json        # Dataset lineage tracking
│   ├── pipeline/            # L0-L3 parquet files
│   ├── analysis/            # ML model outputs
│   ├── cache/               # API response cache
│   ├── manual/              # Manual downloads (CSVs, GeoJSONs)
│   └── logs/                # Pipeline logs
│
├── notebooks/               # Jupyter notebooks (paired with .py via jupytext)
│
├── tests/                   # pytest test suite
│
└── .planning/codebase/      # This documentation
```

## Key Locations

| Purpose | Location |
|---------|----------|
| **Pipeline entry** | `scripts/run_pipeline.py` |
| **Config** | `scripts/core/config.py` |
| **Data I/O** | `scripts/core/data_helpers.py` |
| **Geocoding** | `scripts/core/geocoding.py` |
| **Webapp data prep** | `scripts/core/stages/webapp_data_preparation.py` |
| **Metadata** | `data/metadata.json` |
| **Frontend config** | `app/astro.config.mjs` |
| **Frontend pages** | `app/src/pages/` |

## Dataset Naming Convention

**Pattern**: `L{stage}_{entity}_{type}.parquet`

**Examples**:
- `L0_hdb_resale.parquet` - Raw HDB data from data.gov.sg
- `L1_hdb_transaction.parquet` - Cleaned, geocoded HDB transactions
- `L2_hdb_with_features.parquet` - Feature-enriched HDB data
- `L3_unified_dataset.parquet` - Combined all property types

## Naming Conventions

| Component | Convention | Example |
|-----------|------------|---------|
| Python modules | snake_case | `data_helpers.py` |
| Python classes | PascalCase | `class Config` |
| Python functions | snake_case | `def load_parquet()` |
| Astro pages | kebab-case | `dashboard/trends.astro` |
| React components | PascalCase | `TrendsDashboard.tsx` |
| Constants | UPPER_SNAKE | `PARQUET_COMPRESSION` |

## Import Paths

**Absolute from project root** (required):
```python
from scripts.core.config import Config
from scripts.core.data_helpers import load_parquet
from scripts.core.stages.L1_process import process_transactions
```

**NOT relative** (breaks when scripts run from different directories):
```python
# Wrong
from ..core.config import Config
```

## Notable Files

| File | Lines | Purpose |
|------|-------|---------|
| `scripts/core/stages/L3_export.py` | 1632 | Main export logic (largest) |
| `scripts/core/mrt_line_mapping.py` | 534 | Hardcoded MRT stations |
| `scripts/data/create_l3_unified_dataset.py` | 1443 | Duplicate L3 logic |
| `scripts/core/stages/L5_metrics.py` | ~700 | Dashboard metrics |
| `scripts/prepare_webapp_data.py` | ~600 | JSON generation for dashboard |

## Data Flow to Frontend

```
scripts/
  └─ run_pipeline.py --stage webapp
       └─ webapp_data_preparation.py
            └─ JSON files → app/public/data/

app/
  └─ Pages read JSONs via fetch()
  └─ React components render dashboards
```
