---
import Layout from '@/layouts/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import InlineChartRenderer from '@/components/charts/InlineChartRenderer';
import { getCollection, render } from 'astro:content';

// Generate static paths for all analytics docs
export async function getStaticPaths() {
  const docs = await getCollection('analytics');
  return docs.map((doc) => ({
    params: { slug: doc.slug },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const { Content, headings } = await render(doc);

const title = doc.data.title || 'Untitled';
const status = doc.data.status;
const date = doc.data.date;

// Format headings for TOC
const tocHeadings = headings.map((h) => ({
  id: h.slug,
  text: h.text,
  level: h.depth,
}));
---

<Layout title={`${title} - Analytics`}>
  <Sidebar />
  <TableOfContents headings={tocHeadings} />

  <main class="flex-1 ml-0 lg:ml-64 mr-0 xl:mr-64">
    <div class="max-w-4xl mx-auto px-4 sm:px-8 py-12">
      <!-- Breadcrumb -->
      <nav class="mb-4">
        <ol class="flex items-center space-x-2 text-sm">
          <li>
            <a
              href={`${import.meta.env.BASE_URL}analytics/`}
              class="text-muted-foreground hover:text-foreground"
            >
              Analytics
            </a>
          </li>
          <li class="text-muted-foreground">/</li>
          <li class="text-foreground font-medium">{title}</li>
        </ol>
      </nav>

      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-center gap-3 mb-3">
          <h1 class="text-4xl font-bold text-foreground">{title}</h1>
          {status && (
            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-primary/10 text-primary">
              {status}
            </span>
          )}
        </div>
        {date && (
          <p class="text-sm text-muted-foreground">Updated: {date}</p>
        )}
      </header>

      <!-- Markdown Content -->
      <article class="prose prose-slate max-w-none dark:prose-invert mb-8" id="article-content">
        <Content />
      </article>

      <style>
        /* Custom styling for rendered content */
        .prose table {
          @apply w-full border-collapse my-6;
        }
        .prose th,
        .prose td {
          @apply border border-border px-4 py-2 text-left;
        }
        .prose th {
          @apply bg-muted font-semibold text-foreground;
        }
        .prose tr:hover {
          @apply bg-muted/50;
        }
        
        /* KaTeX Styling adjustments */
        .katex-display {
          @apply overflow-x-auto py-4;
        }
      </style>

      <!-- Inline Charts (scans DOM for tables to visualize) -->
      <InlineChartRenderer client:only="react" />

      <!-- Footer Navigation -->
      <nav class="mt-12 pt-8 border-t border-border">
        <a
          href={`${import.meta.env.BASE_URL}analytics/`}
          class="inline-flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          <svg
            class="w-4 h-4 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width={2}
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          Back to Analytics Overview
        </a>
      </nav>
    </div>
  </main>
</Layout>
